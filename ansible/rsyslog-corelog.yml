---
- name: Configure rsyslog and command logging
  hosts: Linux
  become: yes
  vars:
    rsyslog_conf: "/etc/rsyslog.conf"

  tasks:
    - name: Backup original rsyslog.conf
      ansible.builtin.copy:
        src: "{{ rsyslog_conf }}"
        dest: "{{ rsyslog_conf }}.bak"
        remote_src: yes

    - name: Add template definition and remote logging configuration
      ansible.builtin.blockinfile:
        path: "{{ rsyslog_conf }}"
        marker: "# {mark} ANSIBLE MANAGED BLOCK - REMOTE LOGGING"
        block: |
          # Define template for no timestamp format
          $template noTimestampFormat,"%syslogtag%%msg%\n"
          
          # Remote logging configuration
          kern.*;user.*;daemon.*;auth.*;authpriv.*;syslog.*;cron.*;security.* @{{ corelog_ip }}:514;noTimestampFormat
        insertafter: EOF
      notify:
        - validate rsyslog config
        - restart rsyslog

  handlers:
    - name: validate rsyslog config
      command: rsyslogd -N1 -f "{{ rsyslog_conf }}"
      register: rsyslog_validate
      changed_when: false
      failed_when: rsyslog_validate.rc != 0
      listen: "restart rsyslog"

    - name: restart rsyslog
      ansible.builtin.service:
        name: rsyslog
        state: restarted
